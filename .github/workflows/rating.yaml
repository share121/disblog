name: Rating

on:
  discussion:
    types: [created, edited]

permissions:
  discussions: write

jobs:
  add-label:
    runs-on: ubuntu-latest
    steps:
      - run: |
          #!/bin/bash

          # 设置环境变量
          GITHUB_TOKEN="$githubToken"
          DISCUSSION_ID="$discussionId"
          REPO="$repo"
          OWNER=$(echo $REPO | cut -d'/' -f1)
          REPO_NAME=$(echo $REPO | cut -d'/' -f2)
          # 定义 GraphQL 请求函数
          graphql_request() {
            curl -X POST https://api.github.com/graphql \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              --data "{\"query\":\"$1\"}"
          }

          # 清除讨论上的所有标签
          clear_labels() {
            graphql_request "
            mutation {
              clearLabelsFromLabelable(input: {labelableId: \"$DISCUSSION_ID\"}) {
                clientMutationId
              }
            }
          " | jq -r '.data.clearLabelsFromLabelable.clientMutationId'
          }

          # 获取标签ID
          get_label_id() {
            graphql_request "
            {
              repository(owner: \"$OWNER\", name: \"$REPO_NAME\") {
                label(name: \"$1\") {
                  id
                }
              }
            }
          " | jq -r '.data.repository.label.id'
          }

          # 添加标签到讨论
          add_label() {
            LABEL_ID=$(get_label_id "$1")
            graphql_request "
            mutation {
              addLabelsToLabelable(
                input: {labelableId: \"$DISCUSSION_ID\", labelIds: [\"$LABEL_ID\"]}
              ) {
                clientMutationId
              }
            }
          " | jq -r '.data.addLabelsToLabelable.clientMutationId'
          }

          # 执行清除标签操作
          clear_labels

          # 添加 "待审核" 标签
          add_label "待审核"

  nsfw-rating:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 8
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install -P

      - name: Rating Images
        env:
          actionId: ${{ github.run_id }}
          jobId: ${{ github.job}}
          repo: ${{ github.repository }}
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          discussionId: ${{ github.event.discussion.node_id }}
          discussionBody: ${{ github.event.discussion.body }}
        run: node actions/nsfw_rating.js

  discussion-rating:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 8
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install -P

      - name: Install Ollama
        run: curl -fsSL https://ollama.com/install.sh | sh

      - name: Install Qwen2.5 7B
        run: ollama pull qwen2.5:7b

      - name: Rating discussion
        env:
          actionId: ${{ github.run_id }}
          jobId: ${{ github.job}}
          repo: ${{ github.repository }}
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          discussionId: ${{ github.event.discussion.node_id }}
          discussionTitle: ${{ github.event.discussion.title }}
          discussionBody: ${{ github.event.discussion.body }}
        run: node actions/rating.js

  summary:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 8
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install -P

      - name: Install Ollama
        run: curl -fsSL https://ollama.com/install.sh | sh

      - name: Install Qwen2.5 7B
        run: ollama pull qwen2.5:7b

      - name: Summary discussion
        env:
          actionId: ${{ github.run_id }}
          jobId: ${{ github.job}}
          owner: ${{ github.repository_owner }}
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          discussionId: ${{ github.event.discussion.node_id }}
          discussionTitle: ${{ github.event.discussion.title }}
          discussionBody: ${{ github.event.discussion.body }}
        run: node actions/summary.js
